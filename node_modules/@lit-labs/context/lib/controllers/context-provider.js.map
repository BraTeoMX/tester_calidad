{"version":3,"file":"context-provider.js","sources":["../../src/lib/controllers/context-provider.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2021 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */\n\nimport {ContextRequestEvent} from '../context-request-event.js';\nimport {Context, ContextType} from '../create-context.js';\nimport {ValueNotifier} from '../value-notifier.js';\nimport {ReactiveController, ReactiveElement} from 'lit';\n\ndeclare global {\n  interface HTMLElementEventMap {\n    /**\n     * A 'context-provider' event can be emitted by any element which hosts\n     * a context provider to indicate it is available for use.\n     */\n    'context-provider': ContextProviderEvent<Context<unknown, unknown>>;\n  }\n}\n\nexport class ContextProviderEvent<\n  C extends Context<unknown, unknown>\n> extends Event {\n  /**\n   *\n   * @param context the context which this provider can provide\n   */\n  public constructor(public readonly context: C) {\n    super('context-provider', {bubbles: true, composed: true});\n  }\n}\n\nexport interface Options<C extends Context<unknown, unknown>> {\n  context: C;\n  initialValue?: ContextType<C>;\n}\n\n/**\n * A ReactiveController which adds context provider behavior to a\n * custom element.\n *\n * This controller simply listens to the `context-request` event when\n * the host is connected to the DOM and registers the received callbacks\n * against its observable Context implementation.\n */\nexport class ContextProvider<T extends Context<unknown, unknown>>\n  extends ValueNotifier<ContextType<T>>\n  implements ReactiveController\n{\n  protected host: ReactiveElement;\n  private context: T;\n\n  constructor(host: ReactiveElement, options: Options<T>);\n  /** @deprecated Use new ContextProvider(host, options) */\n  constructor(host: ReactiveElement, context: T, initialValue?: ContextType<T>);\n  constructor(\n    host: ReactiveElement,\n    contextOrOptions: T | Options<T>,\n    initialValue?: ContextType<T>\n  ) {\n    super(\n      (contextOrOptions as Options<T>).context !== undefined\n        ? (contextOrOptions as Options<T>).initialValue\n        : initialValue\n    );\n    this.host = host;\n    if ((contextOrOptions as Options<T>).context !== undefined) {\n      this.context = (contextOrOptions as Options<T>).context;\n    } else {\n      this.context = contextOrOptions as T;\n    }\n    this.attachListeners();\n    this.host.addController(this);\n  }\n\n  public onContextRequest = (\n    ev: ContextRequestEvent<Context<unknown, unknown>>\n  ): void => {\n    // Only call the callback if the context matches.\n    // Also, in case an element is a consumer AND a provider\n    // of the same context, we want to avoid the element to self-register.\n    // The check on composedPath (as opposed to ev.target) is to cover cases\n    // where the consumer is in the shadowDom of the provider (in which case,\n    // event.target === this.host because of event retargeting).\n    if (ev.context !== this.context || ev.composedPath()[0] === this.host) {\n      return;\n    }\n    ev.stopPropagation();\n    this.addCallback(ev.callback, ev.subscribe);\n  };\n\n  private attachListeners() {\n    this.host.addEventListener('context-request', this.onContextRequest);\n  }\n\n  hostConnected(): void {\n    // emit an event to signal a provider is available for this context\n    this.host.dispatchEvent(new ContextProviderEvent(this.context));\n  }\n}\n"],"names":["ContextProviderEvent","Event","constructor","context","super","bubbles","composed","this","ContextProvider","ValueNotifier","host","contextOrOptions","initialValue","undefined","onContextRequest","ev","composedPath","stopPropagation","addCallback","callback","subscribe","attachListeners","addController","addEventListener","hostConnected","dispatchEvent"],"mappings":";;;;;GAqBM,MAAOA,UAEHC,MAKRC,YAAmCC,GACjCC,MAAM,mBAAoB,CAACC,SAAS,EAAMC,UAAU,IADnBC,KAAOJ,QAAPA,CAElC,EAgBG,MAAOK,UACHC,EASRP,YACEQ,EACAC,EACAC,GAEAR,WAC+CS,IAA5CF,EAAgCR,QAC5BQ,EAAgCC,aACjCA,GAYDL,KAAAO,iBACLC,IAQIA,EAAGZ,UAAYI,KAAKJ,SAAWY,EAAGC,eAAe,KAAOT,KAAKG,OAGjEK,EAAGE,kBACHV,KAAKW,YAAYH,EAAGI,SAAUJ,EAAGK,WAAU,EAvB3Cb,KAAKG,KAAOA,OACqCG,IAA5CF,EAAgCR,QACnCI,KAAKJ,QAAWQ,EAAgCR,QAEhDI,KAAKJ,QAAUQ,EAEjBJ,KAAKc,kBACLd,KAAKG,KAAKY,cAAcf,KACzB,CAkBOc,kBACNd,KAAKG,KAAKa,iBAAiB,kBAAmBhB,KAAKO,iBACpD,CAEDU,gBAEEjB,KAAKG,KAAKe,cAAc,IAAIzB,EAAqBO,KAAKJ,SACvD"}